---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';
let galleries = [];

try {
    const response = await fetch(`${API_URL}/api/galleries`);
    if (response.ok) {
        galleries = await response.json();
    }
} catch (e) {
    console.error('Failed to fetch galleries in component', e);
}

// Map real gallery images to the format expected by the masonry grid
const dynamicItems = galleries.flatMap(g => 
    (g.images || []).map((img, index) => ({
        year: "2023", // Placeholder for now
        title: img.filename,
        category: g.title,
        image: `${API_URL}${img.url}`,
        galleryId: g.id,
        index: index
    }))
);

// Fallback items if no dynamic items are found
const fallbackItems = [
    {
        year: "2023",
        title: "Midnight Echoes",
        category: "Oil on Canvas",
        image: "https://lh3.googleusercontent.com/aida-public/AB6AXuCDU9KP9hN3KAMFrb-k-a76avtTxBsIuTqQQatqJgYnX2ewBmAKfZoz1-ZVJefW1W2EUTDP0c9HD4IpfTUJAyHWM2NYlh-sKlx0aLPWJlPhgaazqu9bs9fXDJhS1X4BQObJMQsZqWzNyCtOSA1S5WnwpDjYUNXI6Y9WV_GRvtcnLUUqsB9EDhLg5xGeQyFxYrmxJ18rUtWwb4JFjRTRDvXV9fx-fNqR8IoOj-m2AbEzL-Su7SbLRPlxmtTkSfcfPiRQbEcegAPthArf",
        galleryId: null,
        index: 0
    },
    {
        year: "2024",
        title: "Urban Silence",
        category: "Mixed Media",
        image: "https://lh3.googleusercontent.com/aida-public/AB6AXuDmWSxD3_lIpE42dfa4-9frTscDlwLqI7Ps-4GemoaR5hCrcBkddpHu1s0qN27PsJmQYjBF_shtCLdIPmvLgNgLDl2yem8-2tlep7mE8tz3dQCfcoZLdm_hlG44TihARIDZDFwv9nMPosUguKcadeGD2inb84HHtNuCI4p-Z3kCtM9rU_QUFeBt6_RKAku3Vt6shCTrGXQabJlniF2TgXh45oJdz1J_eVpQ7dTG9zsQVbLUriBDAlqmKte9t2Pvf0bnYZAZlizBJySP",
        galleryId: null,
        index: 0
    },
    {
        year: "2023",
        title: "Fluidity",
        category: "Digital Art",
        image: "https://lh3.googleusercontent.com/aida-public/AB6AXuD7Ro1CfS8sWA0lg5RTwJMtzjgKRm0FPV53YFbGMoJSO-6zQfet8jnVukLXoGBvXSJKA6L0uK7w0OfUPz2YSpNiC73fVQ9Tc-zm9-71DTwvxSk4NOmUBzoTbwc66DfZ38i9dOS5OYoanWeGIcHFzuzKr3zS7fQmMcTlrghpO0WadakY5Yz_MeQucEhEVDFeLGJtreJP7lqfFzMbiaQQwATDEQlSA9ic7w-_FCEdrSsQ3lzXcjtVYMW-ApDwqbaBhDEtXmK5p9NwJ4Dz",
        galleryId: null,
        index: 0
    }
];

const displayItems = dynamicItems.length > 0 ? dynamicItems : fallbackItems;
---

<main class="w-full px-6 md:px-12 py-24 max-w-[1400px] mx-auto">
    <div class="flex flex-col md:flex-row justify-between items-end mb-16 gap-6">
        <div>
            <h2 class="text-3xl md:text-4xl font-bold mb-4">{t('projects.title')}</h2>
            <p class="text-slate-500 dark:text-slate-400">Curated pieces from the 2023-2024 collection.</p>
        </div>
        <div class="flex gap-4 md:gap-8 border-b border-slate-100 pb-2 overflow-x-auto no-scrollbar max-w-full">
            <button 
                class="text-xs uppercase tracking-tighter font-bold border-b-2 border-primary pb-2 whitespace-nowrap tab-btn active" 
                data-category="all"
            >
                {lang === 'en' ? 'All Projects' : 'VÅ¡echny projekty'}
            </button>
            {galleries.map(g => (
                <button 
                    class="text-xs uppercase tracking-tighter font-medium text-slate-400 hover:text-slate-900 transition-colors pb-2 whitespace-nowrap tab-btn" 
                    data-category={g.title}
                >
                    {g.title}
                </button>
            ))}
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 masonry-grid" id="masonry-container">
        {displayItems.map((item) => (
            <a href={item.galleryId ? (lang === 'en' ? `/en/item/${item.galleryId}/${item.index}` : `/item/${item.galleryId}/${item.index}`) : '#'} 
               class="relative aspect-[4/5] overflow-hidden rounded-2xl bg-slate-50 group/item masonry-item border border-slate-100"
               data-category={item.category}>
                <img class="w-full h-full object-cover grayscale opacity-90 hover:grayscale-0 hover:opacity-100 transition-all duration-1000 scale-100 group-hover/item:scale-110" src={item.image} alt={item.title} />
                <div class="absolute inset-0 bg-white/60 backdrop-blur-sm opacity-0 group-hover/item:opacity-100 transition-opacity flex items-center justify-center p-6">
                    <p class="text-slate-900 font-bold text-xs uppercase tracking-widest border-b border-slate-900 pb-1">View Detail</p>
                </div>
            </a>
        ))}
    </div>
    
    <div class="mt-20 flex justify-center">
        <a href={lang === 'en' ? "/en/gallery" : "/gallery"} class="flex items-center gap-4 text-slate-300 hover:text-primary transition-colors group">
            <span class="text-xs font-bold uppercase tracking-[0.3em]">Explore Collection</span>
            <div class="h-px w-12 bg-slate-200 group-hover:w-24 group-hover:bg-primary transition-all"></div>
        </a>
    </div>

    <script>
        const setupTabs = () => {
            const tabs = document.querySelectorAll('.tab-btn');
            const items = document.querySelectorAll('.masonry-item');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const category = tab.getAttribute('data-category');

                    // Update active tab styling
                    tabs.forEach(t => {
                        t.classList.remove('active', 'font-bold', 'border-b-2', 'border-primary');
                        t.classList.add('text-slate-400', 'font-medium');
                    });
                    tab.classList.add('active', 'font-bold', 'border-b-2', 'border-primary');
                    tab.classList.remove('text-slate-400', 'font-medium');

                    // Filter items
                    items.forEach(item => {
                        const itemCategory = item.getAttribute('data-category');
                        if (category === 'all' || itemCategory === category) {
                            (item as HTMLElement).style.display = 'block';
                            // Add a small animation/fade in
                            (item as HTMLElement).style.opacity = '0';
                            setTimeout(() => {
                                (item as HTMLElement).style.opacity = '1';
                                (item as HTMLElement).style.transition = 'opacity 0.4s ease-out';
                            }, 10);
                        } else {
                            (item as HTMLElement).style.display = 'none';
                        }
                    });
                });
            });
        };

        // Initialize on page load
        setupTabs();

        // Re-initialize after view transitions if needed
        document.addEventListener('astro:after-swap', setupTabs);
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
    </style>
</main>
