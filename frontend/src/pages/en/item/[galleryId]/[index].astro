---
import Layout from '../../../../layouts/Layout.astro';
import { getLangFromUrl, useTranslations } from '../../../../i18n/utils';

export const prerender = false;

const { galleryId, index } = Astro.params;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';
let gallery = null;
let item = null;
let prevIndex = null;
let nextIndex = null;
let totalCount = 0;
let navLabels = {};

try {
    if (response.ok) {
        const galleries = await response.json();
        gallery = galleries.find(g => g.id === galleryId);
        if (gallery && gallery.images) {
            totalCount = gallery.images.length;
            const idx = parseInt(index);
            item = gallery.images[idx];
            
            if (idx > 0) prevIndex = idx - 1;
            if (idx < totalCount - 1) nextIndex = idx + 1;
        }
    }

    const settingsResponse = await fetch(`${API_URL}/api/settings`);
    if (settingsResponse.ok) {
        const data = await settingsResponse.json();
        if (lang === 'en') {
            navLabels = {
                works: data.nav_works_en,
                philosophy: data.nav_philosophy_en,
                exhibitions: data.nav_exhibitions_en,
                contact: data.nav_contact_en,
                inquire: data.nav_inquire_en,
            };
        } else {
            navLabels = {
                works: data.nav_works_cz,
                philosophy: data.nav_philosophy_cz,
                exhibitions: data.nav_exhibitions_cz,
                contact: data.nav_contact_cz,
                inquire: data.nav_inquire_cz,
            };
        }
    }
} catch (e) {
    console.error('Failed to fetch data', e);
}

if (!item) {
    return Astro.redirect('/en/gallery');
}

const currentDisplay = parseInt(index) + 1;
---

<Layout title={`${item.filename} | ${gallery.title}`}>
    <style>
        .art-zoom:hover img {
            transform: scale(1.05);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #1754cf20;
            border-radius: 10px;
        }
    </style>

    <div class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200 transition-colors duration-300 min-h-screen overflow-x-hidden">
        <!-- Navigation Header -->
        <nav class="fixed top-0 left-0 right-0 z-50 px-8 py-6 flex justify-between items-center bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md">
            <a class="group flex items-center space-x-2 text-primary font-medium tracking-tight" href="/en/gallery">
                <span class="material-icons text-sm group-hover:-translate-x-1 transition-transform">arrow_back</span>
                <span>Return to Gallery</span>
            </a>
            <div class="hidden md:flex space-x-8 text-xs uppercase tracking-[0.2em] font-semibold text-slate-500 dark:text-slate-400">
                <a class="hover:text-primary transition-colors" href="/en">{navLabels.works || t('nav.works')}</a>
                <a class="hover:text-primary transition-colors" href="/en/exhibitions">{navLabels.exhibitions || t('nav.exhibitions')}</a>
                <a class="hover:text-primary transition-colors" href="/en/philosophy">{navLabels.philosophy || 'About'}</a>
                <a class="hover:text-primary transition-colors" href="/en/contact">{navLabels.contact || t('nav.contact')}</a>
            </div>
            <div class="md:hidden">
                <span class="material-icons">menu</span>
            </div>
        </nav>

        <main class="min-h-screen pt-24 pb-32 px-6 lg:px-12 mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 xl:gap-20">
                <!-- Left Side: Artwork Image -->
                <div class="lg:col-span-7 xl:col-span-8">
                    <div class="sticky top-32 overflow-hidden rounded-xl bg-white dark:bg-slate-900 shadow-2xl shadow-primary/5 group art-zoom max-h-[calc(100vh-160px)]">
                        <img src={`${API_URL}${item.url}`} alt={item.filename} class="w-full h-full object-contain transition-transform duration-700 ease-out cursor-crosshair"/>
                    </div>
                    <div class="mt-6 flex items-center justify-between text-slate-400 dark:text-slate-500 text-xs">
                        <p>Click to view high-resolution texture details</p>
                        <p>© 2026 Alex Carter. {t('footer.rights')}</p>
                    </div>
                </div>

                <!-- Right Side: Details & Narrative -->
                <div class="lg:col-span-5 xl:col-span-4 flex flex-col space-y-12">
                    <!-- Technical Specifications -->
                    <section class="space-y-6">
                        <div class="space-y-2">
                            <span class="text-primary font-semibold tracking-widest text-xs uppercase">Series: {gallery.title}</span>
                            <h1 class="text-4xl lg:text-5xl font-bold text-slate-900 dark:text-white leading-tight">{item.title || item.filename}</h1>
                            <p class="text-xl text-slate-400 dark:text-slate-500 italic">2023</p>
                        </div>
                        <div class="grid grid-cols-2 gap-8 py-8 border-y border-primary/10">
                            <div>
                                <p class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Medium</p>
                                <p class="font-medium">Mixed Media on Canvas</p>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Dimensions</p>
                                <p class="font-medium">120cm × 150cm</p>
                            </div>
                        </div>
                    </section>

                    <!-- Poetic Description -->
                    <section class="space-y-6">
                        <h3 class="text-sm font-semibold uppercase tracking-widest text-primary">Artist's Statement</h3>
                        <div class="space-y-4 text-slate-600 dark:text-slate-300 leading-relaxed text-lg font-light">
                            <p>
                                "This piece explores the liminal space between recollection and reality. Conceived during a period of profound isolation, where the absence of external noise amplified the internal dialogue of memory."
                            </p>
                            <p>
                                The heavy impasto technique in the lower quadrants represents the weight of the physical world, while the translucent glaze layers at the top suggest the fleeting, ephemeral nature of thought.
                            </p>
                        </div>
                    </section>

                    <!-- Actions -->
                    <section class="pt-6 space-y-4">
                        <button class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-4 rounded-xl transition-all shadow-lg shadow-primary/20 flex items-center justify-center space-x-2">
                            <span class="material-icons text-sm">mail_outline</span>
                            <span>Inquire about this piece</span>
                        </button>
                        <button class="w-full bg-primary/10 dark:bg-primary/20 hover:bg-primary/20 dark:hover:bg-primary/30 text-primary font-semibold py-4 rounded-xl transition-all flex items-center justify-center space-x-2">
                            <span class="material-icons text-sm">file_download</span>
                            <span>Download Catalog Entry (PDF)</span>
                        </button>
                    </section>

                    <!-- Tags -->
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-[10px] uppercase tracking-wider font-semibold">Abstract</span>
                        <span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-[10px] uppercase tracking-wider font-semibold">Contemporary</span>
                        <span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-[10px] uppercase tracking-wider font-semibold">Blue</span>
                        <span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-[10px] uppercase tracking-wider font-semibold">Minimalism</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <footer class="fixed bottom-0 left-0 right-0 z-40 px-8 py-8 pointer-events-none">
            <div class="flex justify-between items-center">
                <!-- Previous -->
                {prevIndex !== null ? (
                    <a class="pointer-events-auto group flex flex-col items-start bg-white/90 dark:bg-background-dark/90 backdrop-blur-md p-4 rounded-xl border border-primary/5 shadow-xl transition-transform hover:-translate-y-1" 
                       href={`/en/item/${galleryId}/${prevIndex}`}>
                        <span class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Previous Work</span>
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-primary group-hover:-translate-x-1 transition-transform">west</span>
                            <span class="font-medium text-sm">{gallery.images[prevIndex].filename}</span>
                        </div>
                    </a>
                ) : <div class="w-1"></div>}

                <!-- Pagination Indicator -->
                <div class="hidden md:flex pointer-events-auto bg-white/90 dark:bg-background-dark/90 backdrop-blur-md px-6 py-2 rounded-full border border-primary/5 shadow-xl items-center space-x-4">
                    <span class="text-xs font-bold text-primary tracking-widest">{currentDisplay.toString().padStart(2, '0')} / {totalCount.toString().padStart(2, '0')}</span>
                    <div class="w-24 h-1 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full bg-primary" style={`width: ${(currentDisplay/totalCount)*100}%`}></div>
                    </div>
                </div>

                <!-- Next -->
                {nextIndex !== null ? (
                    <a class="pointer-events-auto group flex flex-col items-end bg-white/90 dark:bg-background-dark/90 backdrop-blur-md p-4 rounded-xl border border-primary/5 shadow-xl transition-transform hover:-translate-y-1 text-right" 
                       href={`/en/item/${galleryId}/${nextIndex}`}>
                        <span class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Next Work</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-medium text-sm">{gallery.images[nextIndex].filename}</span>
                            <span class="material-icons text-primary group-hover:translate-x-1 transition-transform">east</span>
                        </div>
                    </a>
                ) : <div class="w-1"></div>}
            </div>
        </footer>
    </div>
</Layout>
